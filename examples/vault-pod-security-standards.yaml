apiVersion: "vault.banzaicloud.com/v1alpha1"
kind: "Vault"
metadata:
  name: "vault-pod-security-example"
  namespace: vault-system
spec:
  size: 3
  image: hashicorp/vault:1.15.6

  # Annotations to ensure security compliance - these will be applied to Vault pods
  vaultAnnotations:
    vault.security.banzaicloud.io/run-as-non-root: "true"
    vault.security.banzaicloud.io/readonly-root-fs: "true"
    vault.security.banzaicloud.io/run-as-user: "1000"
    vault.security.banzaicloud.io/run-as-group: "1000"
    
  # Configurer annotations for security compliance
  vaultConfigurerAnnotations:
    vault.security.banzaicloud.io/run-as-non-root: "true"
    vault.security.banzaicloud.io/readonly-root-fs: "true"
    vault.security.banzaicloud.io/run-as-user: "1000"
    vault.security.banzaicloud.io/run-as-group: "1000"

  # Environment variables for Pod Security compliance
  vaultEnvsConfig:
    - name: SKIP_CHOWN
      value: "true"
    - name: SKIP_SETCAP
      value: "true"
    - name: VAULT_DISABLE_MLOCK
      value: "true"

  # Service configuration
  serviceType: ClusterIP
  serviceAccount: vault

  # Persistent storage
  volumeClaimTemplates:
    - metadata:
        name: vault-raft
      spec:
        accessModes: [ReadWriteOnce]
        resources:
          requests:
            storage: 1Gi

  volumeMounts:
    - name: vault-raft
      mountPath: /vault/file

  # Vault configuration for HA with Raft
  config:
    storage:
      raft:
        path: "/vault/file"
    listener:
      tcp:
        address: "0.0.0.0:8200"
        tls_disable: true
    api_addr: "http://vault-pod-security-example:8200"
    cluster_addr: "http://${.Env.POD_NAME}:8201"
    ui: true
    disable_mlock: true

  # Unsealing configuration
  unsealConfig:
    options:
      preFlightChecks: true
      storeRootToken: true
      secretShares: 5
      secretThreshold: 3
    kubernetes:
      secretNamespace: vault-system

  # Resource requirements
  resources:
    vault:
      limits:
        memory: 512Mi
        cpu: 500m
      requests:
        memory: 256Mi
        cpu: 250m